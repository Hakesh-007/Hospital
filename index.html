<!DOCTYPE html>
<html>
<head>
<title>HMS Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
    background: linear-gradient(120deg, #eef2f7, #e3e9ff);
    min-height: 100vh;
}

.auth-container {
    width: 360px;
    margin: 80px auto;
    background: white;
    padding: 30px;
    border-radius: 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    animation: fadeIn .5s ease;
}

input, select {
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    border-radius: 10px;
    border: 1px solid #ddd;
    transition: .3s;
    font-size: 14px;
    box-sizing: border-box;
}

input:focus, select:focus {
    border-color: #4a6cf7;
    outline: none;
    box-shadow: 0 0 5px rgba(74,108,247,.3);
}

button {
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    border: none;
    border-radius: 10px;
    background: linear-gradient(135deg, #4a6cf7, #6f8cff);
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: .3s;
    box-sizing: border-box;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(74,108,247,.4);
}

.topnav {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    min-height: 50px;
    background: linear-gradient(135deg, #1abc9c, #16a085);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 20px;
    z-index: 1000;
    box-shadow: 0 2px 12px rgba(0,0,0,.15);
    flex-wrap: wrap;
}

.topnav h3 {
    color: white;
    margin: 0;
    font-weight: 600;
    font-size: 18px;
}

.nav-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
}

.nav-buttons button {
    background: rgba(255,255,255,0.15);
    border-radius: 6px;
    backdrop-filter: blur(6px);
    padding: 6px 12px;
    font-size: 13px;
    width: auto;
    margin-top: 0;
    flex-shrink: 0;
}

.nav-buttons button:hover {
    background: rgba(255,255,255,0.3);
}

.main {
    margin-top: 65px;
    padding: 25px;
    animation: fadeIn .6s ease;
}

.card {
    background: white;
    padding: 25px;
    border-radius: 18px;
    box-shadow: 0 8px 25px rgba(0,0,0,.08);
    margin-bottom: 25px;
    transition: .3s;
}

.card:hover {
    transform: translateY(-4px);
}

.page {
    display: none;
}

.active {
    display: block;
}

.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-box {
    background: white;
    padding: 25px;
    border-radius: 18px;
    box-shadow: 0 8px 20px rgba(0,0,0,.08);
    text-align: center;
    transition: .3s;
}

.stat-box:hover {
    transform: scale(1.05);
}

.stat-box h3 {
    margin: 0;
    font-size: 26px;
    color: #16a085;
}

.stat-box p {
    margin-top: 8px;
    color: #555;
}

/* Table UI */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    border-radius: 12px;
    overflow: hidden;
}

th {
    background: #16a085;
    color: white;
    padding: 12px;
    font-weight: 500;
}

td {
    padding: 12px;
    border-bottom: 1px solid #eee;
}

tr:hover {
    background: #f7f9ff;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Billing specific styles */
.amount-input {
    position: relative;
}

.amount-input::before {
    content: '‚Çπ';
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
    font-weight: bold;
    z-index: 1;
}

#amount {
    padding-left: 30px;
}

.rupee-symbol {
    color: #28a745;
    font-weight: bold;
}

/* Responsive */
@media (max-width: 768px) {
    .auth-container {
        width: 90%;
        margin: 40px auto;
        padding: 20px;
    }
    
    .topnav {
        padding: 5px 10px;
    }
    
    .nav-buttons {
        gap: 5px;
    }
    
    .main {
        padding: 15px;
    }
    
    .card {
        padding: 15px;
    }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="auth-container">
    <h2>üè• HMS Login</h2>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password">
    <button onclick="login()">Sign In</button>
    <button onclick="showSignup()">Create Account</button>
    <p id="loginMsg" style="color: red; text-align: center;"></p>
</div>

<!-- SIGNUP -->
<div id="signupPage" class="auth-container" style="display:none">
    <h2>üè• Create Account</h2>
    <input id="signupUser" placeholder="Username">
    <input id="signupPass" type="password" placeholder="Password">
    <button onclick="signup()">Sign Up</button>
    <button onclick="showLogin()">Back to Login</button>
    <p id="signupMsg" style="text-align: center;"></p>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none">
    <div class="topnav">
        <h3>üè• Hospital Management System</h3>
        <div class="nav-buttons">
            <button onclick="showPage('home')">üè† Dashboard</button>
            <button onclick="showPage('appointment')">üìÖ Appointments</button>
            <button onclick="showPage('history')">üìã Patient History</button>
            <button onclick="showPage('lab')">üß™ Lab / Pharmacy</button>
            <button onclick="showPage('billing')">üí∞ Billing</button>
            <button onclick="logout()">üö™ Logout</button>
        </div>
    </div>

    <div class="main">
        <div id="home" class="page active">
            <!-- Reception Desk Banner -->
            <div class="card" style="background:linear-gradient(135deg,#1abc9c,#16a085);color:white;">
                <h2>üè• Hospital Reception Desk</h2>
                <p>Register patients, manage walk‚Äëins, and guide them to doctors quickly.</p>
            </div>

            <!-- Patient Quick Registration -->
            <div class="card">
                <h3>üìù Patient Check‚ÄëIn</h3>
                <input id="walkName" placeholder="Patient Name">
                <select id="walkDept">
                    <option value="">Select Department</option>
                    <option>Cardiology</option>
                    <option>Neurology</option>
                    <option>Orthopedics</option>
                    <option>General</option>
                </select>
                <button onclick="addWalkIn()">Register Patient</button>
            </div>

            <!-- Live Patient Queue -->
            <div class="card">
                <h3>üìã Waiting Queue</h3>
                <table>
                    <thead>
                        <tr><th>Token</th><th>Patient</th><th>Department</th><th>Action</th></tr>
                    </thead>
                    <tbody id="queueTable"></tbody>
                </table>
            </div>

            <!-- Doctor Availability Widget -->
            <div class="card">
                <h3>üë®‚Äç‚öïÔ∏è Doctor Availability</h3>
                <table>
                    <thead>
                        <tr><th>Doctor</th><th>Department</th><th>Status</th><th>Action</th></tr>
                    </thead>
                    <tbody id="doctorAvailabilityTable"></tbody>
                </table>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <h3>‚ö° Quick Actions</h3>
                <div style="display:flex;gap:15px;flex-wrap:wrap;">
                    <button style="flex:1" onclick="showPage('appointment')">‚ûï New Appointment</button>
                    <button style="flex:1" onclick="showPage('history')">ü©∫ Add Patient Record</button>
                    <button style="flex:1" onclick="showPage('billing')">üí≥ Create Bill</button>
                    <button style="flex:1" onclick="showPage('lab')">üß™ Add Lab Entry</button>
                </div>
            </div>

            <!-- System Info -->
            <div class="card">
                <h3>üìä System Information</h3>
                <p><strong>Hospital Management System (HMS)</strong> helps hospitals manage patients, doctors, billing, and lab/pharmacy records efficiently.</p>
                <p>Use the navigation bar to switch between different modules.</p>
            </div>
        </div>

        <!-- APPOINTMENT -->
        <div id="appointment" class="page">
            <div class="card">
                <h2>üìÖ Doctor Appointment</h2>
                <input id="pname" placeholder="Patient Name">
                <select id="sector" onchange="updateDoctors()">
                    <option value="">Select Department</option>
                    <option value="Cardiology">Cardiology</option>
                    <option value="Neurology">Neurology</option>
                    <option value="Orthopedics">Orthopedics</option>
                    <option value="General">General</option>
                </select>
                <select id="doctor">
                    <option value="">Select Doctor</option>
                </select>
                <input id="time" type="time">
                <input id="date" type="date">
                <button onclick="addAppointment()">Book Appointment</button>
                
                <h3 style="margin-top: 30px;">üìã Scheduled Appointments</h3>
                <table>
                    <thead>
                        <tr><th>Patient</th><th>Dept</th><th>Doctor</th><th>Date</th><th>Time</th><th>Action</th></tr>
                    </thead>
                    <tbody id="appointmentTable"></tbody>
                </table>
            </div>
        </div>

        <!-- PATIENT HISTORY -->
        <div id="history" class="page">
            <div class="card">
                <h2>üìã Patient Medical History</h2>
                <input id="hname" placeholder="Patient Name">
                <input id="diagnosis" placeholder="Diagnosis">
                <input id="treatment" placeholder="Treatment">
                <button onclick="addHistory()">Save Record</button>
                
                <h3 style="margin-top: 30px;">üìñ Medical Records</h3>
                <table>
                    <thead>
                        <tr><th>Name</th><th>Diagnosis</th><th>Treatment</th><th>Action</th></tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </div>

        <!-- LAB / PHARMACY -->
        <div id="lab" class="page">
            <div class="card">
                <h2>üß™ Lab / Pharmacy</h2>
                <input id="lname" placeholder="Patient Name">
                <input id="test" placeholder="Test / Medicine">
                <button onclick="addLab()">Add Record</button>
                
                <h3 style="margin-top: 30px;">üìä Lab & Pharmacy Records</h3>
                <table>
                    <thead>
                        <tr><th>Patient</th><th>Test / Medicine</th><th>Action</th></tr>
                    </thead>
                    <tbody id="labTable"></tbody>
                </table>
            </div>
        </div>

        <!-- BILLING -->
        <div id="billing" class="page">
            <div class="card">
                <h2>üí∞ Billing (Indian Rupee)</h2>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <h4 style="margin-top: 0;">üìù Generate New Bill</h4>
                    <input id="bname" placeholder="Patient Name">
                    <div style="position: relative;">
                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #666; font-weight: bold; z-index: 1;">‚Çπ</span>
                        <input id="amount" type="number" placeholder="Amount" style="padding-left: 30px;">
                    </div>
                    <button onclick="addBill()">Generate Bill</button>
                </div>
                
                <h3 style="margin-top: 30px;">üßæ Billing Records</h3>
                <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; border-left: 4px solid #28a745;">
                    <h4 style="margin-top: 0; color: #28a745;">üìä Today's Summary</h4>
                    <p style="margin: 5px 0;"><strong>Total Bills Generated:</strong> <span id="totalBills">0</span></p>
                    <p style="margin: 5px 0;"><strong>Total Revenue:</strong> <span id="totalRevenue" class="rupee-symbol">‚Çπ0</span></p>
                </div>
                
                <table>
                    <thead>
                        <tr><th>Patient</th><th>Amount (‚Çπ)</th><th>Date</th><th>Action</th></tr>
                    </thead>
                    <tbody id="billTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize localStorage data on first load
function initializeStorage() {
    if (!localStorage.getItem('users')) {
        localStorage.setItem('users', JSON.stringify([]));
    }
    if (!localStorage.getItem('appointments')) {
        localStorage.setItem('appointments', JSON.stringify([]));
    }
    if (!localStorage.getItem('bills')) {
        localStorage.setItem('bills', JSON.stringify([]));
    }
    if (!localStorage.getItem('history')) {
        localStorage.setItem('history', JSON.stringify([]));
    }
    if (!localStorage.getItem('lab')) {
        localStorage.setItem('lab', JSON.stringify([]));
    }
    if (!localStorage.getItem('queue')) {
        localStorage.setItem('queue', JSON.stringify([]));
    }
}

// AUTH FUNCTIONS
function showSignup() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('signupPage').style.display = 'block';
    document.getElementById('signupMsg').innerText = '';
}

function showLogin() {
    document.getElementById('signupPage').style.display = 'none';
    document.getElementById('loginPage').style.display = 'block';
    document.getElementById('loginMsg').innerText = '';
}

function signup() {
    let users = JSON.parse(localStorage.getItem('users')) || [];
    let u = document.getElementById('signupUser').value.trim();
    let p = document.getElementById('signupPass').value.trim();
    
    if (!u || !p) {
        document.getElementById('signupMsg').innerText = 'Please fill all fields';
        document.getElementById('signupMsg').style.color = 'red';
        return;
    }
    
    if (users.find(x => x.u === u)) {
        document.getElementById('signupMsg').innerText = 'User already exists';
        document.getElementById('signupMsg').style.color = 'red';
        return;
    }
    
    users.push({u, p});
    localStorage.setItem('users', JSON.stringify(users));
    document.getElementById('signupMsg').innerText = 'Account created successfully!';
    document.getElementById('signupMsg').style.color = 'green';
    
    // Clear fields
    document.getElementById('signupUser').value = '';
    document.getElementById('signupPass').value = '';
    
    setTimeout(() => {
        showLogin();
    }, 1000);
}

function login() {
    let users = JSON.parse(localStorage.getItem('users')) || [];
    let u = document.getElementById('loginUser').value.trim();
    let p = document.getElementById('loginPass').value.trim();
    
    if (!u || !p) {
        document.getElementById('loginMsg').innerText = 'Please enter username and password';
        return;
    }
    
    if (users.find(x => x.u === u && x.p === p)) {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        loadAll();
    } else {
        document.getElementById('loginMsg').innerText = 'Invalid username or password';
    }
}

function logout() {
    localStorage.removeItem('currentUser');
    location.reload();
}

function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    // Load specific data for the page
    if (id === 'appointment') loadAppointments();
    if (id === 'history') loadHistory();
    if (id === 'lab') loadLab();
    if (id === 'billing') {
        loadBills();
        updateBillingSummary();
    }
}

// DOCTOR DATA
const doctorData = {
    Cardiology: ['Dr. Muthu', 'Dr. Ganesh', 'Dr. Rajesh', 'Dr. Naresh'],
    Neurology: ['Dr. Logesh', 'Dr. Naveen', 'Dr. Suresh', 'Dr. Dhinesh'],
    Orthopedics: ['Dr. Harish', 'Dr. Praveen', 'Dr. Sufiyan', 'Dr. Rudhiran'],
    General: ['Dr. Hakesh', 'Dr. Sherya', 'Dr. Maran', 'Dr. Hema']
};

function getAllDoctors() {
    let all = [];
    Object.keys(doctorData).forEach(dept => {
        doctorData[dept].forEach(doc => {
            all.push({name: doc, dept: dept, status: 'Available'});
        });
    });
    return all;
}

function loadDoctorAvailability() {
    let stored = JSON.parse(localStorage.getItem('doctorAvailability'));
    if (!stored) {
        stored = getAllDoctors();
        localStorage.setItem('doctorAvailability', JSON.stringify(stored));
    }

    const table = document.getElementById('doctorAvailabilityTable');
    if (!table) return;

    table.innerHTML = '';
    stored.forEach((d, i) => {
        table.innerHTML += `<tr>
            <td>${d.name}</td>
            <td>${d.dept}</td>
            <td>${d.status}</td>
            <td><button onclick="toggleDoctor(${i})">Toggle Status</button></td>
        </tr>`;
    });
}

function toggleDoctor(index) {
    let data = JSON.parse(localStorage.getItem('doctorAvailability')) || [];
    data[index].status = data[index].status === 'Available' ? 'Unavailable' : 'Available';
    localStorage.setItem('doctorAvailability', JSON.stringify(data));
    loadDoctorAvailability();
}

function updateDoctors() {
    const doctorSelect = document.getElementById('doctor');
    const sectorVal = document.getElementById('sector').value;
    doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
    
    if (sectorVal && doctorData[sectorVal]) {
        doctorData[sectorVal].forEach(d => {
            doctorSelect.innerHTML += `<option>${d}</option>`;
        });
    }
}

// APPOINTMENTS
function addAppointment() {
    const pname = document.getElementById('pname').value.trim();
    const sector = document.getElementById('sector').value;
    const doctor = document.getElementById('doctor').value;
    const date = document.getElementById('date').value;
    const time = document.getElementById('time').value;

    if (!pname || !sector || !doctor || !date || !time) {
        alert('Please fill all fields');
        return;
    }

    let data = JSON.parse(localStorage.getItem('appointments')) || [];
    data.push({pname, sector, doctor, date, time});
    localStorage.setItem('appointments', JSON.stringify(data));
    
    // Clear form
    document.getElementById('pname').value = '';
    document.getElementById('sector').value = '';
    document.getElementById('doctor').innerHTML = '<option value="">Select Doctor</option>';
    document.getElementById('date').value = '';
    document.getElementById('time').value = '';
    
    loadAppointments();
}

function loadAppointments() {
    let data = JSON.parse(localStorage.getItem('appointments')) || [];
    const table = document.getElementById('appointmentTable');
    table.innerHTML = '';

    data.forEach((a, i) => {
        table.innerHTML += `<tr>
            <td>${a.pname}</td>
            <td>${a.sector}</td>
            <td>${a.doctor}</td>
            <td>${a.date}</td>
            <td>${a.time}</td>
            <td><button onclick="deleteAppointment(${i})">Delete</button></td>
        </tr>`;
    });
}

function deleteAppointment(i) {
    let data = JSON.parse(localStorage.getItem('appointments')) || [];
    data.splice(i, 1);
    localStorage.setItem('appointments', JSON.stringify(data));
    loadAppointments();
}

// PATIENT HISTORY
function addHistory() {
    const name = document.getElementById('hname').value.trim();
    const diagnosis = document.getElementById('diagnosis').value.trim();
    const treatment = document.getElementById('treatment').value.trim();

    if (!name || !diagnosis || !treatment) {
        alert('Please fill all fields');
        return;
    }

    let data = JSON.parse(localStorage.getItem('history')) || [];
    data.push({name, diagnosis, treatment});
    localStorage.setItem('history', JSON.stringify(data));
    
    // Clear form
    document.getElementById('hname').value = '';
    document.getElementById('diagnosis').value = '';
    document.getElementById('treatment').value = '';
    
    loadHistory();
}

function loadHistory() {
    let data = JSON.parse(localStorage.getItem('history')) || [];
    const table = document.getElementById('historyTable');
    table.innerHTML = '';

    data.forEach((h, i) => {
        table.innerHTML += `<tr>
            <td>${h.name}</td>
            <td>${h.diagnosis}</td>
            <td>${h.treatment}</td>
            <td><button onclick="deleteHistory(${i})">Delete</button></td>
        </tr>`;
    });
}

function deleteHistory(i) {
    let data = JSON.parse(localStorage.getItem('history')) || [];
    data.splice(i, 1);
    localStorage.setItem('history', JSON.stringify(data));
    loadHistory();
}

// LAB/PHARMACY
function addLab() {
    const name = document.getElementById('lname').value.trim();
    const test = document.getElementById('test').value.trim();

    if (!name || !test) {
        alert('Please fill all fields');
        return;
    }

    let data = JSON.parse(localStorage.getItem('lab')) || [];
    data.push({name, test});
    localStorage.setItem('lab', JSON.stringify(data));
    
    // Clear form
    document.getElementById('lname').value = '';
    document.getElementById('test').value = '';
    
    loadLab();
}

function loadLab() {
    let data = JSON.parse(localStorage.getItem('lab')) || [];
    const table = document.getElementById('labTable');
    table.innerHTML = '';

    data.forEach((l, i) => {
        table.innerHTML += `<tr>
            <td>${l.name}</td>
            <td>${l.test}</td>
            <td><button onclick="deleteLab(${i})">Delete</button></td>
        </tr>`;
    });
}

function deleteLab(i) {
    let data = JSON.parse(localStorage.getItem('lab')) || [];
    data.splice(i, 1);
    localStorage.setItem('lab', JSON.stringify(data));
    loadLab();
}

// BILLING FUNCTIONS WITH INDIAN RUPEE
// ADD THIS FUNCTION IF IT DOESN'T EXIST
function formatIndianRupee(amount) {
    if (!amount && amount !== 0) return '‚Çπ0';
    
    amount = parseFloat(amount);
    if (isNaN(amount)) return '‚Çπ0';
    
    // Handle negative numbers
    const sign = amount < 0 ? '-' : '';
    amount = Math.abs(amount);
    
    // Split into integer and decimal parts
    const parts = amount.toFixed(2).split('.');
    let integerPart = parts[0];
    const decimalPart = parts[1] || '00';
    
    // Apply Indian numbering system (lakhs, crores)
    if (integerPart.length > 3) {
        const lastThree = integerPart.substring(integerPart.length - 3);
        const otherNumbers = integerPart.substring(0, integerPart.length - 3);
        
        if (otherNumbers !== '') {
            // Add comma after every 2 digits from right (except for the last 3 digits)
            const formattedOtherNumbers = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",");
            integerPart = formattedOtherNumbers + ',' + lastThree;
        }
    }
    
    // Build the final formatted string
    let formatted = sign + '‚Çπ' + integerPart;
    
    // Add decimal part if not .00
    if (decimalPart !== '00') {
        formatted += '.' + decimalPart;
    }
    
    return formatted;
}

function addBill() {
    const name = document.getElementById('bname').value.trim();
    const amount = document.getElementById('amount').value;
    const today = new Date().toISOString().split('T')[0];

    if (!name || !amount) {
        alert('Please fill all fields');
        return;
    }

    if (parseFloat(amount) <= 0) {
        alert('Please enter a valid amount');
        return;
    }

    let data = JSON.parse(localStorage.getItem('bills')) || [];
    data.push({
        name, 
        amount: parseFloat(amount).toFixed(2),
        date: today
    });
    localStorage.setItem('bills', JSON.stringify(data));
    
    // Clear form
    document.getElementById('bname').value = '';
    document.getElementById('amount').value = '';
    
    loadBills();
    updateBillingSummary();
    alert(`Bill of ${formatIndianRupee(amount)} generated for ${name}`);
}

function loadBills() {
    let data = JSON.parse(localStorage.getItem('bills')) || [];
    const table = document.getElementById('billTable');
    table.innerHTML = '';

    // Sort by date (newest first)
    data.sort((a, b) => new Date(b.date) - new Date(a.date));

    data.forEach((b, i) => {
        table.innerHTML += `<tr>
            <td>${b.name}</td>
            <td><span class="rupee-symbol">${formatIndianRupee(b.amount)}</span></td>
            <td>${b.date || 'N/A'}</td>
            <td><button onclick="deleteBill(${i})">Delete</button></td>
        </tr>`;
    });
}

function updateBillingSummary() {
    let data = JSON.parse(localStorage.getItem('bills')) || [];
    const today = new Date().toISOString().split('T')[0];
    
    // Calculate total bills
    const totalBills = data.length;
    
    // Calculate total revenue
    const totalRevenue = data.reduce((sum, bill) => {
        return sum + parseFloat(bill.amount || 0);
    }, 0);
    
    // Calculate today's revenue
    const todayRevenue = data.reduce((sum, bill) => {
        if (bill.date === today) {
            return sum + parseFloat(bill.amount || 0);
        }
        return sum;
    }, 0);
    
    // Update display
    document.getElementById('totalBills').textContent = totalBills;
    document.getElementById('totalRevenue').innerHTML = formatIndianRupee(totalRevenue);
    
    // Add today's revenue to summary box if needed
    const summaryBox = document.querySelector('#billing .card > div:nth-child(2)');
    if (summaryBox) {
        const todayRevenueElement = summaryBox.querySelector('#todayRevenue');
        if (!todayRevenueElement) {
            summaryBox.innerHTML += `<p style="margin: 5px 0;"><strong>Today's Revenue:</strong> <span id="todayRevenue" class="rupee-symbol">${formatIndianRupee(todayRevenue)}</span></p>`;
        } else {
            todayRevenueElement.innerHTML = formatIndianRupee(todayRevenue);
        }
    }
}

function deleteBill(i) {
    let data = JSON.parse(localStorage.getItem('bills')) || [];
    const billToDelete = data[i];
    
    if (confirm(`Are you sure you want to delete the bill of ${formatIndianRupee(billToDelete.amount)} for ${billToDelete.name}?`)) {
        data.splice(i, 1);
        localStorage.setItem('bills', JSON.stringify(data));
        loadBills();
        updateBillingSummary();
    }
}

// RECEPTION QUEUE
function addWalkIn() {
    const name = document.getElementById('walkName').value.trim();
    const dept = document.getElementById('walkDept').value;
    
    if (!name || !dept) {
        alert('Please enter patient name and select department');
        return;
    }

    let queue = JSON.parse(localStorage.getItem('queue')) || [];
    const token = queue.length + 1;
    queue.push({token, name, dept});
    localStorage.setItem('queue', JSON.stringify(queue));
    
    // Clear form
    document.getElementById('walkName').value = '';
    document.getElementById('walkDept').value = '';
    
    loadQueue();
}

function loadQueue() {
    let queue = JSON.parse(localStorage.getItem('queue')) || [];
    const table = document.getElementById('queueTable');
    if (!table) return;

    table.innerHTML = '';
    queue.forEach((q, i) => {
        table.innerHTML += `<tr>
            <td>${q.token}</td>
            <td>${q.name}</td>
            <td>${q.dept}</td>
            <td><button onclick="servePatient(${i})">Send to Doctor</button></td>
        </tr>`;
    });
}

function servePatient(index) {
    let queue = JSON.parse(localStorage.getItem('queue')) || [];
    const servedPatient = queue[index];
    
    // Optional: Add to patient history automatically
    let history = JSON.parse(localStorage.getItem('history')) || [];
    history.push({
        name: servedPatient.name,
        diagnosis: "Walk-in consultation",
        treatment: "General check-up"
    });
    localStorage.setItem('history', JSON.stringify(history));
    
    queue.splice(index, 1);
    localStorage.setItem('queue', JSON.stringify(queue));
    loadQueue();
    alert(`Patient ${servedPatient.name} has been sent to the doctor`);
}

// LOAD ALL DATA
function loadAll() {
    initializeStorage();
    loadAppointments();
    loadBills();
    loadHistory();
    loadLab();
    loadDoctorAvailability();
    loadQueue();
    updateBillingSummary();
    
    // Set today's date as default for appointment
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeStorage();
    
    // Set today's date for the appointment form
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('date');
    if (dateInput) {
        dateInput.value = today;
        dateInput.min = today; // Prevent past dates
    }
    
    // Add rupee symbol to amount input
    const amountInput = document.getElementById('amount');
    if (amountInput) {
        amountInput.placeholder = "0.00";
        amountInput.min = "0";
        amountInput.step = "0.01";
    }
});
</script>
</body>
</html>